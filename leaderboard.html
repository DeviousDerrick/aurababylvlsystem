const apiBase = "https://leaderboardforaurababylvlsystem.onrender.com";

let currentTab = "exp";
let username = sessionStorage.getItem("aurababyUsername") || null;

const usernameInput = document.getElementById("usernameInput");
const submitBtn = document.getElementById("submitBtn");
const submitMsg = document.getElementById("submitMsg");
const leaderboardEl = document.getElementById("leaderboard");
const filterInput = document.getElementById("filterInput");

const expTab = document.getElementById("expTab");
const timeTab = document.getElementById("timeTab");

function niceNum(n){ return n.toLocaleString(); }
function niceTime(t){ return (t || 0) + "s"; }

async function fetchLeaderboard() {
    try {
        const res = await fetch(`${apiBase}/leaderboard`);
        let data = await res.json();

        // Filter if needed
        const filter = (filterInput.value || "").toLowerCase();
        if (filter) {
            data = data.filter(u => u.username.toLowerCase().includes(filter));
        }

        // Sort by tab
        if (currentTab === "exp") {
            data.sort((a,b) => b.exp - a.exp);
        } else {
            data.sort((a,b) => b.time - a.time);
        }

        // Render top 5
        leaderboardEl.innerHTML = "";
        for (let i = 0; i < 5; i++) {
            const div = document.createElement("div");
            if (i < data.length) {
                const u = data[i];
                div.innerHTML = `
                  <strong>${i+1}. ${u.username}</strong> 
                  <span>${niceNum(u.exp)} EXP • ${niceTime(u.time)}</span>
                `;
            } else {
                div.innerHTML = `<strong>${i+1}. ---</strong> <span>0 EXP • 0s</span>`;
            }
            leaderboardEl.appendChild(div);
        }
    } catch (err) {
        console.error("Error fetching leaderboard:", err);
    }
}

async function submitScore(name) {
    const exp = parseInt(localStorage.getItem("exp") || "0");
    const time = parseInt(localStorage.getItem("displaySec") || "0");

    if (exp <= 0 && time <= 0) {
        submitMsg.innerText = "You must earn EXP or TIME before submitting.";
        return;
    }

    try {
        await fetch(`${apiBase}/leaderboard`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: name, exp, time })
        });

        submitMsg.innerText = `Saved! EXP: ${niceNum(exp)}, Time: ${niceTime(time)}`;
        sessionStorage.setItem("aurababyUsername", name); // Only ask once
        usernameInput.disabled = true;
        submitBtn.disabled = true;
        fetchLeaderboard();
    } catch (err) {
        console.error("Error submitting score:", err);
        submitMsg.innerText = "Error submitting score. Try again.";
    }
}

// Handle initial submit
submitBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    if (!name || name.length < 3 || name.length > 20) {
        submitMsg.innerText = "Username must be 3–20 characters.";
        return;
    }
    username = name;
    submitScore(name);
});

// Disable input if already stored
if (username) {
    usernameInput.value = username;
    usernameInput.disabled = true;
    submitBtn.disabled = true;
}

// Refresh/filter handlers
document.getElementById("refreshBtn").addEventListener("click", fetchLeaderboard);
filterInput.addEventListener("input", () => setTimeout(fetchLeaderboard, 200));

// Tabs
expTab.onclick = () => {
    currentTab = "exp";
    expTab.classList.add("active");
    timeTab.classList.remove("active");
    fetchLeaderboard();
};
timeTab.onclick = () => {
    currentTab = "time";
    timeTab.classList.add("active");
    expTab.classList.remove("active");
    fetchLeaderboard();
};

// Initial fetch + auto refresh every 10s
fetchLeaderboard();
setInterval(fetchLeaderboard, 10000);
