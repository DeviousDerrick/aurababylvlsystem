<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Aurababy Leaderboard & Game Center</title>
<link href="fonts.googleapis.com" rel="stylesheet">
<style>
  /* Base Styles */
  body {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    background: linear-gradient(to bottom, #002b80, #0044cc, #0066ff);
    color: white;
    text-align: center;
    padding: 50px 20px;
    margin: 0;
  }
  h1 { font-size: 2.5em; color: #00ffcc; margin-bottom: 20px; }
  #container {
    background: rgba(0,0,0,0.35);
    padding: 30px;
    border-radius: 15px;
    max-width: 600px;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  }

  /* Shared Input/Button Styles */
  input { padding: 8px; border-radius: 6px; border: none; width: 70%; font-size: 1em; box-sizing: border-box; }
  button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 800; margin: 5px; transition: background-color 0.2s; }
  button:hover:enabled { opacity: 0.9; }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  #submitBtn { background: #00ffcc; color: black; }
  #updateBtn { background: #0072ff; color: white; }
  /* Since we are now on one page, the 'backBtn' ID is used for the game-specific save button */
  #saveExpBtn { background: #ff00aa; color: white; } 

  /* Leaderboard Specific Styles (Level System Look) */
  #rankInfo { margin-top:10px; font-size:0.95em; min-height:22px; color: rgba(255,255,255,0.8); }
  #message { color: #ff00aa; }
  #leaderboard div.leaderboard-row {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.05em;
    background: rgba(255, 255, 255, 0.05);
    margin-bottom: 5px;
    border-radius: 8px;
    position: relative;
  }
  #leaderboard div:nth-child(1) { border-left: 5px solid gold; background: rgba(255,215,0,0.15); }
  #leaderboard div:nth-child(2) { border-left: 5px solid silver; background: rgba(192,192,192,0.1); }
  #leaderboard div:nth-child(3) { border-left: 5px solid #cd7f32; background: rgba(205,127,50,0.1); }
  .you { background: rgba(0,255,204,0.15) !important; border-left: 5px solid #00ffcc !important; font-weight: 900; }
  .muted { color: rgba(255,255,255,0.6); font-weight: 600; text-align: center; padding: 10px 0; font-size: 0.9em; }
  .player-info { display: flex; align-items: center; flex-grow: 1; }
  .rank-badge { font-size: 1em; font-weight: 900; width: 30px; text-align: center; margin-right: 15px; color: #00ffcc; }
  .level-badge { background: #ff00aa; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; font-size: 0.8em; font-weight: 900; margin-left: 10px; box-shadow: 0 0 5px rgba(255, 0, 170, 0.5); }
  .player-name { margin-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
  .xp-bar-container { width: 150px; background: rgba(0, 0, 0, 0.5); border-radius: 10px; overflow: hidden; margin-left: auto; box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.8); }
  .xp-bar-fill { height: 12px; background: linear-gradient(to right, #0072ff, #00ffcc); width: 0%; transition: width 0.5s ease-out; text-align: right; line-height: 12px; font-size: 0.7em; font-weight: bold; color: white; padding-right: 3px; }

  /* Game Specific Styles (New Additions for in-page game UI) */
  #game-section {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid rgba(0,255,204,0.5);
  }
  #currentExpDisplay { font-size: 2em; margin: 10px 0; color: #00ffcc; }

</style>
</head>

<body>
<h1>üèÜ Aurababy Command Center üèÜ</h1>
<div id="container">

  <!-- GAME SECTION ADDED HERE -->
  <div id="game-section">
    <h2>Game Status</h2>
    <div>Current Local EXP:</div>
    <div id="currentExpDisplay">0</div>

    <button id="gainExpBtn">Gain 10 EXP</button>
    <button id="saveExpBtn">Save EXP Locally</button>
  </div>
  <!-- END GAME SECTION -->
  
  <div>
    <input type="text" id="usernameInput" placeholder="Enter your username" aria-label="Username input">
    <button id="submitBtn" aria-label="Submit username">Login</button>
  </div>
  <div id="message" style="margin-top:10px; min-height:20px;"></div>

  <button id="updateBtn">Sync EXP & Refresh Ranks</button>

  <div id="rankInfo"></div>

  <div id="leaderboard" style="margin-top:20px;">
    <!-- Leaderboard entries will be dynamically inserted here -->
  </div>

  <!-- Removed the 'Back to Game' button as the game is now here -->
</div>

<script>
const apiBase = "https://leaderboardbackend-7cum.onrender.com";
let username = sessionStorage.getItem("aurababyUsername") || null;

// DOM elements mapping for Leaderboard
const usernameInput = document.getElementById("usernameInput");
const submitBtn = document.getElementById("submitBtn");
const message = document.getElementById("message");
const leaderboardEl = document.getElementById("leaderboard");
const updateBtn = document.getElementById("updateBtn");
const rankInfo = document.getElementById("rankInfo");

// DOM elements mapping for Game (NEW)
const currentExpDisplay = document.getElementById("currentExpDisplay");
const gainExpBtn = document.getElementById("gainExpBtn");
const saveExpBtn = document.getElementById("saveExpBtn");

// --- GAME LOGIC INTEGRATED HERE ---
let currentExp = parseInt(localStorage.getItem("exp") || "0", 10);
currentExpDisplay.textContent = currentExp.toLocaleString();

gainExpBtn.onclick = () => {
    currentExp += 10;
    currentExpDisplay.textContent = currentExp.toLocaleString();
};

saveExpBtn.onclick = () => {
    localStorage.setItem("exp", currentExp);
    alert("EXP saved to local storage!");
};
// --- END GAME LOGIC ---


// Rest of the Leaderboard JS (Same as previous response, just included here)

function expNeededForLevel(level) {
    if (level <= 1) return 0;
    return Math.floor(Math.pow(level - 1, 2) * 100); 
}

function calculateLevelDetails(totalExp) {
    let level = 1;
    let expForCurrent = 0;
    let expForNext = expNeededForLevel(2);
    while (totalExp >= expForNext) {
        level++;
        expForCurrent = expForNext;
        expForNext = expNeededForLevel(level + 1);
    }
    const expInCurrentLevel = totalExp - expForCurrent;
    const neededForNext = expForNext - expForCurrent;
    const progressPercent = neededForNext > 0 ? (expInCurrentLevel / neededForNext) * 100 : 100;
    return {
        level,
        progressPercent: Math.min(progressPercent, 100),
        totalExp: totalExp,
        nextLevelExp: expForNext
    };
}


if (username) {
  usernameInput.value = username;
  usernameInput.disabled = true;
  submitBtn.disabled = true;
  message.innerText = `Pilot ${username} logged in.`;
  updateLeaderboard(); 
}

submitBtn.onclick = () => {
  const name = usernameInput.value.trim();
  if (!name || name.length < 3 || name.length > 20) {
    message.innerText = "Username must be 3‚Äì20 characters.";
    return;
  }
  username = name;
  sessionStorage.setItem("aurababyUsername", username);
  usernameInput.disabled = true;
  submitBtn.disabled = true;
  message.innerText = `Pilot ${username} accepted.`;
  updateLeaderboard();
};

async function fetchLeaderboard() { /* ... function body same as before ... */
  try {
    const res = await fetch(`${apiBase}/leaderboard`);
    if (!res.ok) throw new Error("Failed to fetch leaderboard");
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  } catch (err) {
    console.error(err);
    message.innerText = "Error: Could not reach leaderboard server. Displaying local data only.";
    return [];
  }
}

async function submitEXP() { /* ... function body same as before ... */
  if (!username) return;
  const exp = parseInt(localStorage.getItem("exp") || "0", 10); 
  try {
    const res = await fetch(`${apiBase}/submit`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, exp })
    });
    if (!res.ok) {
      console.warn("Submit EXP returned non-OK status:", res.status);
    }
  } catch(err) {
    console.error(err);
  }
}

async function updateLeaderboard() { /* ... function body same as before ... */
  if (!username) {
    message.innerText = "Please enter a username first to access the Command Center.";
    usernameInput.focus();
    return;
  }
  message.innerText = "";
  rankInfo.innerText = "Syncing data with the mainframe...";
  await submitEXP();
  let data = await fetchLeaderboard();
  data = data.map(d => ({ username: d.username, exp: Number(d.exp) || 0 }));
  data.sort((a,b) => b.exp - a.exp);
  leaderboardEl.innerHTML = "";

  const createLeaderboardRow = (rank, userObj) => {
    const div = document.createElement("div");
    div.classList.add("leaderboard-row");
    const levelDetails = calculateLevelDetails(userObj.exp);
    div.innerHTML = `
      <div class="player-info">
        <span class="rank-badge">${rank}.</span>
        <span class="player-name">${escapeHtml(userObj.username)}</span>
        <span class="level-badge">Lvl ${levelDetails.level}</span>
      </div>
      <div class="xp-bar-container">
        <div class="xp-bar-fill" style="width: ${levelDetails.progressPercent}%">
          ${Math.floor(levelDetails.progressPercent)}%
        </div>
      </div>
    `;
    if (userObj.username.toLowerCase() === username.toLowerCase()) {
      div.classList.add("you");
    }
    return div;
  };

  for (let i = 0; i < 5; i++) {
    if (i < data.length) {
      leaderboardEl.appendChild(createLeaderboardRow(i + 1, data[i]));
    } else {
      const emptyDiv = document.createElement("div");
      emptyDiv.classList.add("leaderboard-row", "muted");
      emptyDiv.innerHTML = `<div class="player-info"><span class="rank-badge">${i+1}.</span> <span class="player-name">--- Empty Slot ---</span></div>`;
      leaderboardEl.appendChild(emptyDiv);
    }
  }

  const myIndex = data.findIndex(u => u.username.toLowerCase() === username.toLowerCase());
  if (myIndex === -1) {
    const myExp = Number(localStorage.getItem("exp") || "0");
    rankInfo.innerText = `You are not ranked on the public list yet. Your local EXP: ${myExp.toLocaleString()}. Click "Sync EXP" to update your status.`;
    const spacer = document.createElement("div");
    spacer.className = "muted";
    spacer.innerText = "Your Rank Details Below...";
    leaderboardEl.appendChild(spacer);
    const myUnrankedUser = { username: username, exp: myExp };
    const selfDiv = createLeaderboardRow("‚Äî", myUnrankedUser);
    leaderboardEl.appendChild(selfDiv);
  } else {
    const rank = myIndex + 1;
    const userDetails = calculateLevelDetails(data[myIndex].exp);
    rankInfo.innerText = `You are ranked #${rank} (Level ${userDetails.level}) out of ${data.length.toLocaleString()} total pilots.`;
    if (myIndex >= 5) {
      const spacer = document.createElement("div");
      spacer.className = "muted";
      spacer.innerText = "... Jump to your rank ...";
      leaderboardEl.appendChild(spacer);
      leaderboardEl.appendChild(createLeaderboardRow(rank, data[myIndex]));
    }
  }
}

updateBtn.onclick = updateLeaderboard;

setInterval(() => {
  if (sessionStorage.getItem("aurababyUsername")) updateLeaderboard();
}, 10000);

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
</script>
</body>
</html>
